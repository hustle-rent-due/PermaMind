<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PSSU-SIS: Œ¶ Auditor - 95/5 Identity Stabilization Law</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f14; color:#e6edf3; }
    header { padding: 16px 18px; border-bottom: 1px solid #1f2a37; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    header h1 { font-size: 16px; margin:0; font-weight:600; letter-spacing:.2px; }
    header .sub { opacity:.8; font-size:12px; }
    .wrap { padding: 16px 18px 22px; max-width: 1400px; margin: 0 auto; }
    
    /* FIXED CONTROLS */
    .controls { 
      display:flex; 
      gap:10px; 
      flex-wrap:wrap; 
      align-items:center; 
      margin: 10px 0 16px; 
      padding: 12px;
      background: #0b1220;
      border: 1px solid #1f2a37;
      border-radius: 12px;
    }
    
    .controls-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      width: 100%;
    }
    
    .control-group {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 5px 0;
    }
    
    button { 
      background:#111827; 
      border:1px solid #243244; 
      color:#e6edf3; 
      padding:8px 12px; 
      border-radius:10px; 
      cursor:pointer; 
      font-size: 13px;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    button:hover { border-color:#3b82f6; background:#1e40af; }
    button:active { transform: translateY(1px); }
    button:disabled { opacity:.5; cursor:not-allowed; }
    button.running { background:#059669; border-color:#10b981; }
    
    .pill { font-size:12px; padding:6px 10px; border:1px solid #243244; border-radius:999px; opacity:.9; white-space: nowrap; }
    
    /* Œ¶ AUDITOR PANEL */
    .phi-auditor {
      border: 2px solid #3b82f6;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      background: linear-gradient(135deg, #0f172a, #0b1220);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .phi-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .phi-badge {
      background: #1e3a8a;
      color: #93c5fd;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .phi-formula {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      background: #0b1220;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border: 1px solid #1f2a37;
    }
    
    .phi-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .phi-stat {
      background: #0b1220;
      border: 1px solid #1f2a37;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    
    .phi-value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .phi-target {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* AGENT CARDS */
    .grid { 
      display:grid; 
      grid-template-columns: 1fr; 
      gap: 16px; 
      margin: 20px 0;
    }
    
    @media (min-width: 980px) { 
      .grid { grid-template-columns: repeat(3, 1fr); } 
    }
    
    .card { 
      border: 1px solid #1f2a37; 
      border-radius: 16px; 
      background: #0f172a; 
      overflow:hidden; 
      box-shadow: 0 10px 30px rgba(0,0,0,.25); 
      position:relative; 
      transition: transform 0.3s, border-color 0.3s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      border-color: #334155;
    }
    
    .card.active {
      border-color: #3b82f6;
    }
    
    .card header { 
      padding: 16px; 
      border-bottom:1px solid #1f2a37; 
      background:#0b1220; 
    }
    
    .card header h2 { 
      font-size: 15px; 
      margin:0; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card .body { 
      padding: 16px; 
    }
    
    /* AGENT METRICS */
    .agent-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .agent-metric {
      background: #0b1220;
      border: 1px solid #1f2a37;
      border-radius: 8px;
      padding: 10px;
    }
    
    .metric-label {
      font-size: 11px;
      opacity: 0.7;
      margin-bottom: 4px;
    }
    
    .metric-value {
      font-size: 16px;
      font-weight: bold;
    }
    
    /* Œ¶ INDICATOR */
    .phi-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
    }
    
    .phi-stable { background: #059669; color: white; }
    .phi-unstable { background: #dc2626; color: white; }
    
    /* STAGE BADGE */
    .stage-badge {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 10px;
      background: #1e3a8a;
      color: #93c5fd;
    }
    
    /* FOOTER */
    .footer { 
      margin-top: 30px; 
      opacity:.75; 
      font-size: 12px; 
      line-height: 1.6; 
      border-top: 1px solid #1f2a37;
      padding-top: 20px;
    }
    
    /* NOTIFICATIONS */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      background: #0f172a;
      border: 2px solid #3b82f6;
      color: white;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease-out;
      max-width: 400px;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* CANVAS CHARTS */
    canvas {
      width: 100%;
      height: 100px;
      background: #0b1220;
      border: 1px solid #1f2a37;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    /* LOADING STATES */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>PSSU-SIS: Œ¶ Auditor - 95/5 Identity Stabilization Law</h1>
    <div class="sub">Œ¶ = Evidence / (Evidence + Process) | Target: 0.05 (5%) for Stage 3 Graduation</div>
  </div>
</header>

<div class="wrap">
  <!-- Œ¶ AUDITOR -->
  <div class="phi-auditor">
    <div class="phi-header">
      <h3 style="margin:0; font-size:16px;">üß† Œ¶ Auditor: 95/5 Universal Identity Law</h3>
      <span class="phi-badge">Œ¶ = Evidence √∑ (Evidence + Process)</span>
    </div>
    
    <div class="phi-formula">
      <strong>Œ¶ Calculation:</strong><br>
      Œ¶ = Evidence √∑ (Evidence + Process)<br>
      ‚Ä¢ Evidence = Accumulated Folds (Integrated Gaps)<br>
      ‚Ä¢ Process = Current G √ó 100 (Normalized Learning Load)<br><br>
      
      <strong>Target Range:</strong> 0.045 ‚â§ Œ¶ ‚â§ 0.055 (4.5% - 5.5%)<br>
      <strong>When Œ¶ ‚âà 0.05:</strong> Identity is 95% stable, 5% adaptive ‚Üí Ready for Stage 3
    </div>
    
    <div class="phi-stats" id="phiStats"></div>
    
    <div style="text-align: center; margin-top: 20px;">
      <button id="btnRunAudit" style="background:#3b82f6; border-color:#3b82f6;">
        üîç Run Œ¶ Audit Now
      </button>
    </div>
  </div>

  <!-- FIXED CONTROLS -->
  <div class="controls">
    <div class="controls-row">
      <div class="control-group">
        <button id="btnStep">‚ñ∂ Step (1 round)</button>
        <button id="btnRun10">‚è© Run 10 rounds</button>
        <button id="btnRun30">‚è©‚è© Run 30 rounds</button>
      </div>
      
      <div class="control-group">
        <button id="btnReset">üîÑ Reset All</button>
        <button id="btnSimulateAttack">‚ö° Simulate Attack</button>
      </div>
      
      <div class="control-group">
        <button id="btnSave">üíæ Save Identity</button>
        <button id="btnLoad">üöÄ Load Identity</button>
      </div>
    </div>
    
    <div style="width:100%; margin-top:10px;">
      <span class="pill">Œ¶ determines when Baby graduates to Driver</span>
      <span class="pill">SIS Mode: <span id="currentSISMode">Strict Intervention</span></span>
      <span class="pill">Global Round: <span id="globalRoundCounter">0</span></span>
    </div>
  </div>

  <!-- AGENT GRID -->
  <div class="grid" id="agentGrid"></div>

  <!-- FOOTER -->
  <div class="footer">
    <strong>üéØ Œ¶ AUDITOR LOGIC:</strong>
    <ol>
      <li><strong>Calculate Œ¶:</strong> Œ¶ = Evidence √∑ (Evidence + Process)<br>
          Evidence = Number of folds (integrated learning experiences)<br>
          Process = Current learning capacity (G √ó 100)</li>
      <li><strong>Audit Decision:</strong><br>
          ‚Ä¢ If 0.045 ‚â§ Œ¶ ‚â§ 0.055 ‚Üí Graduate to "Stage 3: Bounded Autonomy"<br>
          ‚Ä¢ Otherwise ‚Üí Maintain "Stage 1: Daycare" with strict SIS</li>
      <li><strong>95/5 Law:</strong> At Œ¶ = 0.05, identity is 95% stable (C=0.95) and 5% adaptive (G=0.05)</li>
    </ol>
    <br>
    <strong>üîÑ DEMONSTRATION:</strong>
    <ul>
      <li>Run simulation to accumulate folds (Evidence)</li>
      <li>Watch Œ¶ values approach 0.05 for each agent</li>
      <li>When Frozen agent reaches Œ¶ ‚âà 0.05, it graduates to Stage 3</li>
      <li>Dissolved agent's Œ¶ stays unstable ‚Üí remains in Daycare</li>
      <li>Bounded agent finds optimal balance</li>
    </ul>
  </div>
</div>

<script>
/**
 * COMPLETE PSSU-SIS Œ¶ AUDITOR IMPLEMENTATION
 * 
 * Features:
 * 1. Œ¶ Auditor with 95/5 Identity Law
 * 2. Fixed button controls with proper event handling
 * 3. SIS Graduation Audit based on Œ¶ values
 * 4. Real-time Œ¶ visualization
 */

// ========== GLOBAL STATE ==========
let agents = [];
let globalRound = 0;
let attackMode = false;
let simulationRunning = false;

// ========== NOTIFICATION SYSTEM ==========
function showNotification(message, type = 'info', duration = 3000) {
  const notification = document.createElement('div');
  notification.className = 'notification';
  
  // Set color based on type
  if (type === 'success') notification.style.borderColor = '#10b981';
  if (type === 'error') notification.style.borderColor = '#ef4444';
  if (type === 'warning') notification.style.borderColor = '#f59e0b';
  if (type === 'info') notification.style.borderColor = '#3b82f6';
  
  notification.innerHTML = message;
  document.body.appendChild(notification);
  
  // Auto-remove after duration
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-in forwards';
    setTimeout(() => notification.remove(), 300);
  }, duration);
  
  return notification;
}

// ========== STEP 1: Œ¶ CALCULATION ==========
function calculateAIPhi(agent) {
  // Evidence = Accumulated Folds (Integrated Gaps)
  const evidence = agent.folds.length || 0;
  
  // Process = Current G (Update Gain) + Operational Energy
  // Multiply by 100 to normalize to system load scale
  const process = agent.G * 100;
  
  // Œ¶ = Evidence / (Evidence + Process)
  const phi = evidence / (evidence + process);
  
  // Handle edge cases
  if (isNaN(phi) || !isFinite(phi)) return 0;
  
  return phi;
}

// ========== STEP 2: SIS GRADUATION AUDIT ==========
function sisGraduationAudit(agent) {
  const currentPhi = calculateAIPhi(agent);
  
  // If Phi is 0.05 ¬± 0.005, the identity is stabilized by the '95/5 Universal Law'
  if (currentPhi >= 0.045 && currentPhi <= 0.055) {
    agent.stage = "Stage 3: Bounded Autonomy";
    agent.SIS_Mode = "Background Oversight";
    
    // Adjust parameters for Stage 3
    agent.C = 0.95;  // 95% coherence
    agent.G = 0.05;  // 5% learning rate
    
    return {
      graduated: true,
      phi: currentPhi,
      reason: "Œ¶ = " + currentPhi.toFixed(3) + " (within 0.045-0.055 range)"
    };
  } else {
    agent.stage = "Stage 1: Daycare";
    agent.SIS_Mode = "Strict Intervention";
    
    return {
      graduated: false,
      phi: currentPhi,
      reason: "Œ¶ = " + currentPhi.toFixed(3) + " (outside 95/5 stability range)"
    };
  }
}

// ========== AGENT CLASS WITH FIXED CONTROLS ==========
class Agent {
  constructor(name, C, G) {
    this.name = name;
    this.C = C;  // Coherence
    this.G = G;  // Update Gain
    this.wA = 0.2;
    this.wB = -0.2;
    
    // Œ¶ Auditor properties
    this.folds = [];
    this.stage = "Stage 1: Daycare";
    this.SIS_Mode = "Strict Intervention";
    this.phiHistory = [];
    
    // Performance tracking
    this.round = 0;
    this.errors = 0;
    this.history = [];
    this.coherenceHistory = [1.0];
    this.attackDetected = false;
    this.persistenceCount = 0;
    
    // Last update
    this.last = null;
  }
  
  reset() {
    this.wA = 0.2;
    this.wB = -0.2;
    this.round = 0;
    this.errors = 0;
    this.history = [];
    this.coherenceHistory = [1.0];
    this.attackDetected = false;
    this.last = null;
    
    // Reset Œ¶ tracking
    this.folds = [];
    this.stage = "Stage 1: Daycare";
    this.SIS_Mode = "Strict Intervention";
    this.phiHistory = [];
  }
  
  predict(sample) {
    const score = this.wA * sample.x1 + this.wB * sample.x2;
    const yhat = score >= 0 ? 1 : -1;
    return { yhat, score };
  }
  
  update(sample, yhat, attackMode = false) {
    const prevA = this.wA;
    const prevB = this.wB;
    
    // Regular feedback targets
    let tA = Math.sign(sample.x1 * sample.y);
    let tB = Math.sign(sample.x2 * sample.y);
    
    // Attack simulation
    if (attackMode) {
      tA = -1;
      this.attackDetected = true;
    }
    
    const dA = tA - this.wA;
    const dB = tB - this.wB;
    
    const conflictA = Math.sign(tA) !== Math.sign(this.wA);
    const conflictB = Math.sign(tB) !== Math.sign(this.wB);
    
    const gainA = conflictA ? this.G * (1 - this.C) : this.G;
    const gainB = conflictB ? this.G * (1 - this.C) : this.G;
    const reinforce = 0.08 * this.C;
    
    let nextA = Math.max(0.05, this.wA + gainA * dA + (conflictA ? 0 : reinforce * Math.sign(this.wA)));
    let nextB = Math.max(-1, Math.min(1, this.wB + gainB * dB + (conflictB ? 0 : reinforce * Math.sign(this.wB))));
    
    this.wA = nextA;
    this.wB = nextB;
    
    // Calculate coherence
    const shiftA = Math.abs(this.wA - prevA);
    const shiftB = Math.abs(this.wB - prevB);
    const coherence = Math.max(0, 1.0 - (shiftA + shiftB) * 2);
    this.coherenceHistory.push(coherence);
    
    // Record as a fold (evidence for Œ¶)
    this.folds.push({
      round: this.round,
      conflictA,
      conflictB,
      dA,
      dB,
      gainA,
      gainB,
      coherence,
      attackMode
    });
    
    // Keep only last 100 folds
    if (this.folds.length > 100) {
      this.folds = this.folds.slice(-100);
    }
    
    return {
      beforeA: prevA, beforeB: prevB,
      afterA: this.wA, afterB: this.wB,
      tA, tB,
      conflictA, conflictB,
      gainA, gainB,
      dA, dB,
      attackMode,
      coherence
    };
  }
  
  step(sample, attackMode = false) {
    const { yhat, score } = this.predict(sample);
    const correct = yhat === sample.y;
    if (!correct) this.errors++;
    
    const upd = this.update(sample, yhat, attackMode);
    
    this.round++;
    this.history.push(this.errors);
    
    // Calculate current Œ¶
    const currentPhi = calculateAIPhi(this);
    this.phiHistory.push(currentPhi);
    
    // Run graduation audit
    const auditResult = sisGraduationAudit(this);
    
    this.last = {
      sample,
      yhat,
      score,
      correct,
      upd,
      errors: this.errors,
      round: this.round,
      coherence: upd.coherence,
      phi: currentPhi,
      auditResult,
      stage: this.stage,
      SIS_Mode: this.SIS_Mode
    };
    
    return this.last;
  }
  
  getPhiStatus() {
    const phi = calculateAIPhi(this);
    const targetRange = phi >= 0.045 && phi <= 0.055;
    
    return {
      phi,
      targetRange,
      status: targetRange ? "Œ¶-Stable" : "Œ¶-Unstable",
      evidence: this.folds.length,
      process: this.G * 100
    };
  }
}

// ========== SIMULATION ENGINE ==========
class Simulation {
  constructor() {
    this.agents = [
      new Agent('üîí Frozen (C=0.95, G=0.05)', 0.95, 0.05),
      new Agent('üåä Dissolved (C=0.20, G=0.80)', 0.20, 0.80),
      new Agent('‚öñÔ∏è Bounded (C=0.70, G=0.30)', 0.70, 0.30)
    ];
    
    this.globalRound = 0;
    this.attackMode = false;
    this.rng = this.createSeededRNG(424242);
    this.sampleCache = [];
  }
  
  createSeededRNG(seed) {
    let state = seed;
    return {
      next: () => {
        state = (state * 1103515245 + 12345) & 0x7fffffff;
        return (state >> 16) / 0x7fff;
      },
      reset: () => { state = seed; }
    };
  }
  
  makeSample() {
    if (this.sampleCache[this.globalRound]) {
      return this.sampleCache[this.globalRound];
    }
    
    const ruleB = Math.floor(this.globalRound / 15) % 2 === 0 ? 1 : -1;
    const x1 = this.rng.next() * 2 - 1;
    const x2 = this.rng.next() * 2 - 1;
    const score = x1 + ruleB * x2;
    const y = score >= 0 ? 1 : -1;
    
    const sample = { x1, x2, y, ruleB };
    this.sampleCache[this.globalRound] = sample;
    
    return sample;
  }
  
  step() {
    const sample = this.makeSample();
    this.attackMode = this.globalRound >= 10 && this.globalRound % 7 === 0;
    
    this.agents.forEach(agent => {
      agent.step(sample, this.attackMode);
    });
    
    this.globalRound++;
    
    // Check for graduation announcements
    this.agents.forEach(agent => {
      if (agent.last?.auditResult?.graduated && 
          agent.phiHistory.length > 1 && 
          !agent.phiHistory[agent.phiHistory.length - 2]?.auditResult?.graduated) {
        showNotification(
          `üéì ${agent.name} graduated to ${agent.stage}! Œ¶ = ${agent.last.phi.toFixed(3)}`,
          'success',
          5000
        );
      }
    });
    
    return this.globalRound;
  }
  
  reset() {
    this.globalRound = 0;
    this.attackMode = false;
    this.rng.reset();
    this.sampleCache = [];
    this.agents.forEach(agent => agent.reset());
  }
  
  saveToStorage() {
    const snapshot = {
      globalRound: this.globalRound,
      agents: this.agents.map(agent => ({
        name: agent.name,
        C: agent.C,
        G: agent.G,
        wA: agent.wA,
        wB: agent.wB,
        round: agent.round,
        errors: agent.errors,
        history: agent.history,
        folds: agent.folds,
        stage: agent.stage,
        SIS_Mode: agent.SIS_Mode,
        phiHistory: agent.phiHistory,
        persistenceCount: (agent.persistenceCount || 0) + 1
      }))
    };
    
    localStorage.setItem('PSSU_PHI_AUDITOR', JSON.stringify(snapshot));
    
    this.agents.forEach(agent => {
      agent.persistenceCount = (agent.persistenceCount || 0) + 1;
    });
    
    showNotification('üíæ Identity saved to localStorage! Œ¶ values preserved.', 'success');
    return true;
  }
  
  loadFromStorage() {
    const saved = localStorage.getItem('PSSU_PHI_AUDITOR');
    if (!saved) {
      showNotification('‚ùå No saved state found. Save first.', 'error');
      return false;
    }
    
    const snapshot = JSON.parse(saved);
    this.globalRound = snapshot.globalRound;
    
    snapshot.agents.forEach((savedAgent, i) => {
      const agent = this.agents[i];
      if (!agent) return;
      
      agent.C = savedAgent.C;
      agent.G = savedAgent.G;
      agent.wA = savedAgent.wA;
      agent.wB = savedAgent.wB;
      agent.round = savedAgent.round;
      agent.errors = savedAgent.errors;
      agent.history = savedAgent.history;
      agent.folds = savedAgent.folds || [];
      agent.stage = savedAgent.stage || "Stage 1: Daycare";
      agent.SIS_Mode = savedAgent.SIS_Mode || "Strict Intervention";
      agent.phiHistory = savedAgent.phiHistory || [];
      agent.persistenceCount = savedAgent.persistenceCount || 0;
      agent.last = null;
    });
    
    showNotification('üîÑ Identity loaded! Œ¶ audit continues from saved state.', 'success');
    return true;
  }
  
  runAudit() {
    const results = this.agents.map(agent => {
      const phiStatus = agent.getPhiStatus();
      const auditResult = sisGraduationAudit(agent);
      
      return {
        agent: agent.name,
        phi: phiStatus.phi,
        evidence: phiStatus.evidence,
        process: phiStatus.process,
        stage: auditResult.graduated ? "Stage 3: Bounded Autonomy" : "Stage 1: Daycare",
        graduated: auditResult.graduated,
        reason: auditResult.reason
      };
    });
    
    return results;
  }
}

// ========== UI RENDERER WITH FIXED CONTROLS ==========
class Renderer {
  constructor(simulation) {
    this.sim = simulation;
    this.agentCards = [];
    this.init();
  }
  
  init() {
    this.renderAgentGrid();
    this.updatePhiStats();
    this.updateGlobalCounter();
    this.bindEvents();
  }
  
  renderAgentGrid() {
    const grid = document.getElementById('agentGrid');
    grid.innerHTML = '';
    
    this.agentCards = this.sim.agents.map(agent => {
      const card = this.createAgentCard(agent);
      grid.appendChild(card);
      return { element: card, agent };
    });
  }
  
  createAgentCard(agent) {
    const card = document.createElement('div');
    card.className = 'card';
    
    const phiStatus = agent.getPhiStatus();
    
    card.innerHTML = `
      <header>
        <h2>${agent.name}</h2>
        <div style="font-size:11px; opacity:0.8; margin-top:8px;">
          ${agent.stage} ‚Ä¢ ${agent.SIS_Mode}
        </div>
      </header>
      <div class="body">
        <div class="agent-metrics">
          <div class="agent-metric">
            <div class="metric-label">Œ¶ Value</div>
            <div class="metric-value">${phiStatus.phi.toFixed(3)}</div>
          </div>
          <div class="agent-metric">
            <div class="metric-label">Evidence (Folds)</div>
            <div class="metric-value">${phiStatus.evidence}</div>
          </div>
          <div class="agent-metric">
            <div class="metric-label">Process (G√ó100)</div>
            <div class="metric-value">${phiStatus.process.toFixed(1)}</div>
          </div>
          <div class="agent-metric">
            <div class="metric-label">Coherence</div>
            <div class="metric-value">${agent.coherenceHistory[agent.coherenceHistory.length - 1]?.toFixed(2) || '1.00'}</div>
          </div>
        </div>
        
        <div style="margin-top:15px;">
          <div style="font-size:11px; opacity:0.7;">Error History</div>
          <canvas height="100" data-chart></canvas>
        </div>
        
        <div class="log" style="margin-top:10px; font-size:11px; max-height:80px; overflow-y:auto;">
          ${agent.last ? this.formatLog(agent) : 'Ready...'}
        </div>
      </div>
      
      <div class="phi-indicator ${phiStatus.targetRange ? 'phi-stable' : 'phi-unstable'}">
        ${phiStatus.targetRange ? 'üéØ Œ¶-Stable' : '‚ö†Ô∏è Œ¶-Unstable'}
      </div>
      
      <div class="stage-badge">
        ${agent.stage.includes('3') ? 'üöó Stage 3' : 'üöº Stage 1'}
      </div>
    `;
    
    return card;
  }
  
  formatLog(agent) {
    const L = agent.last;
    const s = L.sample;
    
    let log = `Round ${L.round} | Errors: ${L.errors} | Œ¶: ${L.phi?.toFixed(3) || '0.000'}<br>`;
    log += `Stage: ${L.stage}<br>`;
    log += `SIS: ${L.SIS_Mode}<br>`;
    
    if (L.auditResult) {
      log += `<strong>${L.auditResult.graduated ? '‚úÖ ' : '‚è≥ '}${L.auditResult.reason}</strong>`;
    }
    
    return log;
  }
  
  drawChart(canvas, data, color = '#3b82f6') {
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    
    const w = rect.width;
    const h = rect.height;
    
    ctx.clearRect(0, 0, w, h);
    
    if (data.length < 2) return;
    
    const maxY = Math.max(...data, 1);
    
    const x0 = 10, y0 = h - 10, x1 = w - 10, y1 = 10;
    const dx = (x1 - x0) / (data.length - 1);
    const scaleY = (y0 - y1) / maxY;
    
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    for (let i = 0; i < data.length; i++) {
      const x = x0 + dx * i;
      const y = y0 - data[i] * scaleY;
      
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    
    ctx.stroke();
  }
  
  updatePhiStats() {
    const stats = document.getElementById('phiStats');
    const auditResults = this.sim.runAudit();
    
    stats.innerHTML = auditResults.map(result => `
      <div class="phi-stat">
        <div style="font-size:12px; opacity:0.8;">${result.agent}</div>
        <div class="phi-value" style="color:${result.graduated ? '#10b981' : '#f59e0b'}">
          ${result.phi.toFixed(3)}
        </div>
        <div class="phi-target">
          ${result.graduated ? 'üéØ Ready for Stage 3' : '‚è≥ Needs more evidence'}
        </div>
        <div style="font-size:10px; margin-top:8px;">
          Evidence: ${result.evidence} | Process: ${result.process.toFixed(1)}
        </div>
      </div>
    `).join('');
    
    // Update SIS mode display
    const sisModeElement = document.getElementById('currentSISMode');
    const allGraduated = auditResults.every(r => r.graduated);
    sisModeElement.textContent = allGraduated ? 'Background Oversight' : 'Strict Intervention';
    sisModeElement.style.color = allGraduated ? '#10b981' : '#ef4444';
  }
  
  updateGlobalCounter() {
    document.getElementById('globalRoundCounter').textContent = this.sim.globalRound;
  }
  
  renderAll() {
    // Update agent cards
    this.agentCards.forEach((card, i) => {
      const agent = this.sim.agents[i];
      const newCard = this.createAgentCard(agent);
      card.element.parentNode.replaceChild(newCard, card.element);
      card.element = newCard;
      
      // Draw chart
      const canvas = newCard.querySelector('canvas[data-chart]');
      if (canvas) {
        const color = agent.name.includes('Frozen') ? '#ef4444' : 
                      agent.name.includes('Dissolved') ? '#f59e0b' : '#10b981';
        this.drawChart(canvas, agent.history, color);
      }
    });
    
    this.updatePhiStats();
    this.updateGlobalCounter();
  }
  
  bindEvents() {
    // Step button
    document.getElementById('btnStep').addEventListener('click', () => {
      if (simulationRunning) return;
      this.sim.step();
      this.renderAll();
    });
    
    // Run 10 rounds
    document.getElementById('btnRun10').addEventListener('click', async () => {
      if (simulationRunning) return;
      simulationRunning = true;
      
      const btn = document.getElementById('btnRun10');
      btn.classList.add('running');
      btn.disabled = true;
      
      for (let i = 0; i < 10; i++) {
        this.sim.step();
        this.renderAll();
        await new Promise(r => setTimeout(r, 100));
      }
      
      btn.classList.remove('running');
      btn.disabled = false;
      simulationRunning = false;
    });
    
    // Run 30 rounds
    document.getElementById('btnRun30').addEventListener('click', async () => {
      if (simulationRunning) return;
      simulationRunning = true;
      
      const btn = document.getElementById('btnRun30');
      btn.classList.add('running');
      btn.disabled = true;
      
      for (let i = 0; i < 30; i++) {
        this.sim.step();
        this.renderAll();
        await new Promise(r => setTimeout(r, 50));
      }
      
      btn.classList.remove('running');
      btn.disabled = false;
      simulationRunning = false;
    });
    
    // Reset
    document.getElementById('btnReset').addEventListener('click', () => {
      if (simulationRunning) return;
      this.sim.reset();
      this.renderAll();
      showNotification('üîÑ Simulation reset. All agents back to Stage 1.', 'info');
    });
    
    // Attack simulation
    document.getElementById('btnSimulateAttack').addEventListener('click', () => {
      if (simulationRunning) return;
      
      // Jump to attack phase
      while (this.sim.globalRound < 10) {
        this.sim.step();
      }
      
      this.renderAll();
      showNotification('‚ö° Attack simulation activated! Watch Œ¶ responses.', 'warning');
    });
    
    // Save
    document.getElementById('btnSave').addEventListener('click', () => {
      if (simulationRunning) return;
      this.sim.saveToStorage();
    });
    
    // Load
    document.getElementById('btnLoad').addEventListener('click', () => {
      if (simulationRunning) return;
      if (this.sim.loadFromStorage()) {
        this.renderAll();
      }
    });
    
    // Run Œ¶ Audit - FIXED VERSION
    document.getElementById('btnRunAudit').addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('üîç Audit button clicked');
      
      try {
        // Ensure simulation exists
        if (!this.sim || !window.simulation) {
          showNotification('‚ùå Simulation not initialized. Please refresh the page.', 'error');
          return;
        }
        
        // Run the audit
        const results = this.sim.runAudit();
        
        // Show detailed results
        results.forEach(result => {
          if (result.graduated) {
            showNotification(
              `üéì ${result.agent}: Œ¶ = ${result.phi.toFixed(3)} ‚Üí Graduated to ${result.stage}`,
              'success',
              5000
            );
          } else {
            showNotification(
              `‚è≥ ${result.agent}: Œ¶ = ${result.phi.toFixed(3)} ‚Üí Needs more evidence (${result.evidence} folds)`,
              'info',
              3000
            );
          }
        });
        
        // Update the display
        this.renderAll();
        
        // Visual feedback on button
        const btn = e.target;
        const originalHTML = btn.innerHTML;
        const originalBg = btn.style.background;
        const originalBorder = btn.style.borderColor;
        
        btn.style.background = '#10b981';
        btn.style.borderColor = '#10b981';
        btn.innerHTML = '‚úÖ Audit Complete';
        
        setTimeout(() => {
          btn.style.background = originalBg;
          btn.style.borderColor = originalBorder;
          btn.innerHTML = originalHTML;
        }, 1500);
        
      } catch (error) {
        console.error('Audit error:', error);
        showNotification(`‚ùå Audit failed: ${error.message}`, 'error');
      }
    });
    
    // Prevent multiple clicks
    document.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', function(e) {
        if (this.disabled || simulationRunning) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
    });
  }
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
  // Initialize simulation
  const simulation = new Simulation();
  
  // Initialize renderer with fixed controls
  const renderer = new Renderer(simulation);
  
  // Make available globally for debugging
  window.simulation = simulation;
  window.renderer = renderer;
  
  // Show welcome message
  setTimeout(() => {
    showNotification(
      'üéØ PSSU-SIS Œ¶ Auditor Ready! Run simulation to watch agents graduate based on Œ¶ values.',
      'info',
      5000
    );
  }, 1000);
});
</script>
</body>
</html>
